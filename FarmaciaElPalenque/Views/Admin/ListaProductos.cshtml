@model List<Productos>
@{
    ViewData["Title"] = "Lista de Productos";
}

<h2>Lista de Productos</h2>

@if (TempData["Mensaje"] != null)
{
    <div class="alert alert-success">@TempData["Mensaje"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@Html.Raw(TempData["Error"])</div>
}

<p>
    <a asp-action="CrearProducto" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Agregar Producto</a>
    <a asp-action="Panel" class="btn btn-success"><i class="bi bi-arrow-left me-1"></i>Volver al Panel</a>
</p>

<form asp-action="ActualizarLista" method="post" id="product-form">
    @Html.AntiForgeryToken()
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th style="width: 180px;">Nombre</th>
                <th style="width: 120px;">Precio</th>
                <th style="width: 100px;">Stock</th>
                <th style="width: 160px;">Categoría</th>
                <th style="width: 150px;">Imagen</th>
                <th style="width: 100px;">Guardar</th>
                <th style="width: 100px;">Eliminar</th>
            </tr>
        </thead>

        <tbody>
            @for (int i = 0; i < Model.Count; i++)
            {
                <tr>
                    <td>
                        <!-- Nombre compacto con tooltip -->
                        <div class="nombre-compacto"
                             data-bs-toggle="tooltip"
                             data-bs-title="@Model[i].nombre"
                             data-target="nombre-@i"
                             data-index="@i">
                            @(Model[i].nombre.Length > 25 ? Model[i].nombre.Substring(0, 25) + "..." : Model[i].nombre)
                        </div>
                        <input type="hidden" name="[@i].id" value="@Model[i].id" />
                        <input type="hidden" name="[@i].nombre" id="nombre-@i" value="@Model[i].nombre" />
                    </td>

                    <td>
                        <input name="[@i].precio" type="number" step="0.01" value="@Model[i].precio"
                               class="form-control form-control-sm" />
                    </td>

                    <td>
                        <input name="[@i].Stock" type="number" value="@Model[i].Stock"
                               class="form-control form-control-sm" />
                    </td>

                    <td>
                        <select name="[@i].categoriaId" class="form-select form-select-sm">
                            <option value="1" selected="@(Model[i].categoriaId == 1)">Medicamentos</option>
                            <option value="2" selected="@(Model[i].categoriaId == 2)">Perfumería</option>
                            <option value="3" selected="@(Model[i].categoriaId == 3)">Cuidado Personal</option>
                        </select>
                    </td>

                    <td>
                        <!-- Imagen compacta -->
                        <div class="d-flex align-items-center">
                            <img src="@(string.IsNullOrEmpty(Model[i].imagenUrl) ? "/images/default.png" : Model[i].imagenUrl)"
                                 width="40" height="40"
                                 class="me-2 imagen-miniatura"
                                 data-target="imagen-@i"
                                 data-index="@i"
                                 data-bs-toggle="tooltip"
                                 data-bs-title="Haz clic para editar" />
                            <i class="bi bi-pencil-square text-muted small"></i>
                        </div>
                        <input type="hidden" name="[@i].imagenUrl" id="imagen-@i" value="@Model[i].imagenUrl" />
                    </td>

                    <td>
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="bi bi-check-lg"></i>
                        </button>
                    </td>

                    <td>
                        <form asp-action="EliminarProducto" asp-route-id="@Model[i].id" method="post" class="d-inline eliminar-form">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger btn-sm eliminar-btn">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</form>

<!-- Modal para editar nombre -->
<div class="modal fade" id="nombreModal" tabindex="-1" aria-labelledby="nombreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nombreModalLabel">Editar Nombre del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nombreInput" class="form-label">Nombre del producto:</label>
                    <textarea class="form-control" id="nombreInput" rows="4" placeholder="Ingrese el nombre completo del producto"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveNombreBtn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar imagen -->
<div class="modal fade" id="imagenModal" tabindex="-1" aria-labelledby="imagenModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagenModalLabel">Editar URL de Imagen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="imagenInput" class="form-label">URL de la imagen:</label>
                    <textarea class="form-control" id="imagenInput" rows="4" placeholder="https://ejemplo.com/imagen.jpg"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Vista previa:</label>
                    <div id="imagePreviewContainer" class="text-center border p-3 rounded">
                        <img id="imagePreview" class="img-fluid" src="" alt="Vista previa"
                             style="max-height: 300px; object-fit: contain;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveImagenBtn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .nombre-compacto {
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 0.9em;
            border: 1px dashed #dee2e6;
        }

            .nombre-compacto:hover {
                background-color: #e9ecef;
                border-color: #6c757d;
            }

        .imagen-miniatura {
            cursor: pointer;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            transition: transform 0.2s, border-color 0.2s;
        }

            .imagen-miniatura:hover {
                transform: scale(1.05);
                border-color: #007bff;
            }

        .table td {
            padding: 8px;
            vertical-align: middle;
        }

        .form-control-sm, .form-select-sm {
            font-size: 0.875em;
        }
    </style>
    <script>
        // Variables para almacenar el campo actual que se está editando
        let currentFieldId = '';
        let currentIndex = '';

        // Inicializar tooltips
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Mostrar modal para editar nombre
        document.querySelectorAll('.nombre-compacto').forEach(preview => {
            preview.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                currentFieldId = targetId;
                currentIndex = this.getAttribute('data-index');

                const nombreValue = document.getElementById(targetId).value;
                document.getElementById('nombreInput').value = nombreValue;

                const nombreModal = new bootstrap.Modal(document.getElementById('nombreModal'));
                nombreModal.show();
            });
        });

        // Mostrar modal para editar imagen
        document.querySelectorAll('.imagen-miniatura').forEach(img => {
            img.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                currentFieldId = targetId;
                currentIndex = this.getAttribute('data-index');

                const imagenValue = document.getElementById(targetId).value;
                document.getElementById('imagenInput').value = imagenValue;

                // Actualizar vista previa de imagen
                const previewImg = document.getElementById('imagePreview');
                previewImg.src = imagenValue || '/images/default.png';

                const imagenModal = new bootstrap.Modal(document.getElementById('imagenModal'));
                imagenModal.show();
            });
        });

        // Guardar cambios del nombre
        document.getElementById('saveNombreBtn').addEventListener('click', function() {
            const newValue = document.getElementById('nombreInput').value;
            if (newValue.trim() !== '') {
                document.getElementById(currentFieldId).value = newValue;

                // Actualizar la vista previa en la tabla
                const previewElement = document.querySelector(`[data-target="${currentFieldId}"]`);
                const displayText = newValue.length > 25 ? newValue.substring(0, 25) + "..." : newValue;
                previewElement.textContent = displayText;

                // Actualizar el tooltip
                previewElement.setAttribute('data-bs-title', newValue);

                // Cerrar modal
                bootstrap.Modal.getInstance(document.getElementById('nombreModal')).hide();

                // Mostrar mensaje de éxito temporal
                showTemporaryMessage('Nombre actualizado correctamente', 'success');
            } else {
                showTemporaryMessage('El nombre no puede estar vacío', 'danger');
            }
        });

        // Guardar cambios de la imagen
        document.getElementById('saveImagenBtn').addEventListener('click', function() {
            const newValue = document.getElementById('imagenInput').value;
            document.getElementById(currentFieldId).value = newValue;

            // Actualizar la imagen en la tabla
            const imgElement = document.querySelector(`[data-target="${currentFieldId}"]`);
            imgElement.src = newValue || '/images/default.png';

            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('imagenModal')).hide();

            // Mostrar mensaje de éxito temporal
            showTemporaryMessage('URL de imagen actualizada correctamente', 'success');
        });

        // Actualizar vista previa de imagen en tiempo real
        document.getElementById('imagenInput').addEventListener('input', function() {
            const previewImg = document.getElementById('imagePreview');
            previewImg.src = this.value || '/images/default.png';
        });

        // Función para mostrar mensajes temporales
        function showTemporaryMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // Confirmación para eliminar productos
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.eliminar-btn');
            if (!btn) return;
            e.preventDefault();

            const form = btn.closest('form');
            const res = await Swal.fire({
                title: '¿Eliminar este producto?',
                text: 'Esta acción no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (res.isConfirmed) form.submit();
        });
    </script>
}