@model List<Carrito>

@{
    ViewData["Title"] = "Carrito";
    decimal total = ViewBag.Total is decimal d ? d : 0m; // cast seguro
}

@section Styles {
    <link rel="stylesheet" href="~/css/estilos.css" />
}
 
<h2>Carrito</h2>

@if (TempData["Mensaje"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Mensaje"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Html.Raw(TempData["Error"])
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
}
     @{
        var referer = Context.Request.Headers["Referer"].ToString();
        var backUrl = (!string.IsNullOrWhiteSpace(referer) && Url.IsLocalUrl(referer))
            ? referer
            : Url.Action("Index", "Principal");
    }

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info text-center py-4">
        <p class="mb-3 fs-5">🛒 Tu carrito está vacío.</p>

        <div class="d-flex justify-content-center gap-3 flex-wrap">
            <a asp-controller="Principal" asp-action="Index"
               class="btn btn-primary btn-equal btn-compact">
                <i class="bi bi-shop"></i> Volver a comprar
            </a>

            <form asp-controller="Cuenta" asp-action="Logout" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-danger btn-lg btn-equal">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </form>
        </div>
    </div>
}
else
{
    <table class="table align-middle">
        <thead>
            <tr>
                <th></th>
                <th>Producto</th>
                <th>Precio</th>
                <th style="width:140px;">Cantidad</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var i in Model)
            {
                <tr>
                    <td>
                        <img src="@(string.IsNullOrWhiteSpace(i.ImagenUrl) ? "/images/default.png" : i.ImagenUrl)"
                             alt="imagen" style="width:60px;height:60px;object-fit:cover;border-radius:8px;" />
                    </td>
                    <td>@i.Nombre</td>
                    <td>@i.Precio.ToString("C")</td>
                    <td>
                        <form asp-action="CambiarCantidad" method="post" class="d-flex gap-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@i.ProductoId" />
                            <input type="number" name="cantidad" value="@i.Cantidad" min="0" class="form-control form-control-sm" style="width:80px;" />
                            <button class="btn btn-sm btn-outline-primary" type="submit">Actualizar</button>
                        </form>
                    </td>
                    <td>@i.Subtotal.ToString("C")</td>
                    <td>
                        <form asp-action="Quitar" method="post" onsubmit="return confirm('¿Quitar este producto?');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@i.ProductoId" />
                            <button class="btn btn-sm btn-outline-danger" type="submit">Quitar</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <th colspan="4" class="text-end">Total</th>
                <th>@total.ToString("C")</th>
                <th>
                    <form asp-action="Vaciar" method="post" onsubmit="return confirm('¿Vaciar el carrito?');">
                        @Html.AntiForgeryToken()
                        <button class="btn btn-sm btn-outline-secondary" type="submit">Vaciar</button>
                    </form>
                </th>
            </tr>
        </tfoot>
    </table>

    <div class="d-flex gap-2 mt-3">
        <a href="@backUrl" class="btn btn-outline-primary">← Seguir comprando</a>
        <a asp-controller="Checkout" asp-action="Index" class="btn btn-success">Ir a pagar</a>
    </div>
}
